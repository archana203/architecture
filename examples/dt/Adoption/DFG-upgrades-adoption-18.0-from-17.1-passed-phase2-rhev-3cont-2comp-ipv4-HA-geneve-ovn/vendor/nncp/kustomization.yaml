apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

resources:
- ocp_nodes_nncp.yaml

patches:
- target:
    kind: NodeNetworkConfigurationPolicy
    labelSelector: "osp/nncm-config-type=standard"
  path: ocp_node_template.yaml

replacements:
# Common network interfaces and vlans
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.internalapi.mtu
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
    fieldPaths:
    - spec.desiredState.interfaces.0.mtu
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.tenant.mtu
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
    fieldPaths:
    - spec.desiredState.interfaces.2.mtu
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.ctlplane.mtu
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
    fieldPaths:
    - spec.desiredState.interfaces.3.mtu
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.external.mtu
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
    fieldPaths:
    - spec.desiredState.interfaces.1.mtu

# Interface type is ethernet (not vlan)
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.internalapi.iface
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
    fieldPaths:
    - spec.desiredState.interfaces.0.name
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.tenant.iface
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
    fieldPaths:
    - spec.desiredState.interfaces.2.name
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.ctlplane.iface
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
    fieldPaths:
    - spec.desiredState.interfaces.3.name
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.external.iface
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
    fieldPaths:
    - spec.desiredState.interfaces.1.name

# Static Node IPs: node-0
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_0.internalapi_ip
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-0
    fieldPaths:
    - spec.desiredState.interfaces.0.ipv4.address.0.ip
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_0.tenant_ip
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-0
    fieldPaths:
    - spec.desiredState.interfaces.2.ipv4.address.0.ip
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_0.ctlplane_ip
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-0
    fieldPaths:
    - spec.desiredState.interfaces.3.ipv4.address.0.ip
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_0.external_ip
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-0
    fieldPaths:
    - spec.desiredState.interfaces.1.ipv4.address.0.ip

# Static Node IPs: node-1
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_1.internalapi_ip
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-1
    fieldPaths:
    - spec.desiredState.interfaces.0.ipv4.address.0.ip
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_1.tenant_ip
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-1
    fieldPaths:
    - spec.desiredState.interfaces.2.ipv4.address.0.ip
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_1.ctlplane_ip
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-1
    fieldPaths:
    - spec.desiredState.interfaces.3.ipv4.address.0.ip
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_1.external_ip
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-1
    fieldPaths:
    - spec.desiredState.interfaces.1.ipv4.address.0.ip

# Static Node IPs: node-2
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_2.internalapi_ip
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-2
    fieldPaths:
    - spec.desiredState.interfaces.0.ipv4.address.0.ip
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_2.tenant_ip
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-2
    fieldPaths:
    - spec.desiredState.interfaces.2.ipv4.address.0.ip
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_2.ctlplane_ip
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-2
    fieldPaths:
    - spec.desiredState.interfaces.3.ipv4.address.0.ip
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_2.external_ip
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-2
    fieldPaths:
    - spec.desiredState.interfaces.1.ipv4.address.0.ip

# prefix-length: node-0
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.ctlplane.prefix-length
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-0
    fieldPaths:
    - spec.desiredState.interfaces.3.ipv4.address.0.prefix-length
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.internalapi.prefix-length
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-0
    fieldPaths:
    - spec.desiredState.interfaces.0.ipv4.address.0.prefix-length
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.tenant.prefix-length
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-0
    fieldPaths:
    - spec.desiredState.interfaces.2.ipv4.address.0.prefix-length
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.external.prefix-length
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-0
    fieldPaths:
    - spec.desiredState.interfaces.1.ipv4.address.0.prefix-length

# prefix-length: node-1
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.ctlplane.prefix-length
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-1
    fieldPaths:
    - spec.desiredState.interfaces.3.ipv4.address.0.prefix-length
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.internalapi.prefix-length
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-1
    fieldPaths:
    - spec.desiredState.interfaces.0.ipv4.address.0.prefix-length
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.tenant.prefix-length
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-1
    fieldPaths:
    - spec.desiredState.interfaces.2.ipv4.address.0.prefix-length
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.external.prefix-length
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-1
    fieldPaths:
    - spec.desiredState.interfaces.1.ipv4.address.0.prefix-length

# prefix-length: node-2
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.ctlplane.prefix-length
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-2
    fieldPaths:
    - spec.desiredState.interfaces.3.ipv4.address.0.prefix-length
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.internalapi.prefix-length
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-2
    fieldPaths:
    - spec.desiredState.interfaces.0.ipv4.address.0.prefix-length
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.tenant.prefix-length
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-2
    fieldPaths:
    - spec.desiredState.interfaces.2.ipv4.address.0.prefix-length
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.external.prefix-length
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-2
    fieldPaths:
    - spec.desiredState.interfaces.1.ipv4.address.0.prefix-length

# Node names
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_0.name
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-0
    fieldPaths:
    - metadata.name
    - spec.nodeSelector.[kubernetes.io/hostname]
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_1.name
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-1
    fieldPaths:
    - metadata.name
    - spec.nodeSelector.[kubernetes.io/hostname]
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_2.name
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
      name: node-2
    fieldPaths:
    - metadata.name
    - spec.nodeSelector.[kubernetes.io/hostname]

# DNS
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.dns-resolver.config
  targets:
  - select:
      kind: NodeNetworkConfigurationPolicy
    fieldPaths:
    - spec.desiredState.dns-resolver.config
